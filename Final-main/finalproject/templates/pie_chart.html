{% load static %}
    {% load humanize %}
<html lang="ja">
<head>


    <meta charset="UTF-8">
    <title>Pie Chart</title>
  {% load static %}
    <link href="{% static 'accountbook/css/uum.css' %}" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600&display=swap">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">


    <script>
  const labels = {{ labels|safe }};
  const dataValues = {{ data|safe }};
  const fetchUrl = "{% url 'fetch_credit_info' %}";
</script>
</head>
<body>
<style>
  #refresh-btn.btn-outline-dark:hover {
    color: black !important;
    background-color: #e2e6ea;
    border-color: black !important;
  }

  h1.display-4 {
    font-weight: 900;
  }
   #refresh-btn svg {
    width: 20px;
    height: 20px;
    fill: currentColor;  /* ãƒ†ã‚­ã‚¹ãƒˆã®è‰²ã«åˆã‚ã›ã‚‹ */
  }
</style>
<div class="container my-5">
   <div class="d-flex justify-content-start mb-3">
    <a href="{% url 'line_graph' %}" class="btn btn-primary">æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•</a>
  </div>
  <h1 class="text-center display-4 mb-4">ä»Šæœˆã®ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰è«‹æ±‚</h1>

  <div class="d-flex justify-content-end mb-3">
  <button id="refresh-btn" class="btn btn-outline-dark d-flex align-items-center px-3 py-2">
 <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" class="me-2" aria-hidden="true" focusable="false" role="img">      <circle cx="50" cy="50" fill="none" r="45" stroke="black" stroke-width="5"/>
      <path d="M50 15 L65 35 L35 35 Z" fill="currentColor"/>
    </svg>
    æ›´æ–°
  </button>
</div>



  <div class="d-flex justify-content-center align-items-center mb-4 gap-4">
    <a class="btn btn-outline-primary" href="{% url 'pie_chart_month' prev_year prev_month %}">å…ˆæœˆã®è«‹æ±‚</a>
    <div class="h5 mb-0">{{ current_month }}æœˆ</div>
    <a class="btn btn-outline-primary" href="{% url 'pie_chart_month' next_year next_month  %}">æ¥æœˆã®è«‹æ±‚</a>
  </div>

  <!-- å¿…ãš safe|escapejs ã‚’ä¸¡æ–¹ä½¿ã† -->

<div class="d-flex justify-content-center my-3">

  <div class="btn-group" role="group">
    <button id="category-btn" class="btn btn-outline-primary active">ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ¥</button>
    <button id="tag-btn" class="btn btn-outline-primary">ã‚¿ã‚°åˆ¥</button>
  </div>
<!-- å¿…ãš safe|escapejs ã‚’ä¸¡æ–¹ä½¿ã† -->

</div>
  <div class="d-flex justify-content-center mb-4">
    <canvas id="myPieChart" width="600" height="600"></canvas>
  </div>

  <div id="no-data-message" class="text-center fs-3 text-muted" style="display: none;">
    ä»Šæœˆã¯å‚ç…§ã™ã‚‹è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚
  </div>

      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


  <div id="chart-data"
     data-labels='{{ labels|safe|escapejs }}'
     data-values='{{ data|safe|escapejs }}'
     data-tag-labels='{{ tag_labels|safe|escapejs }}'
     data-tag-values='{{ tag_values|default:"[]"|safe|escapejs }}'>
</div>

  <script>

  </script>
  <!-- åˆè¨ˆé‡‘é¡è¡¨ç¤º -->
  <div class="text-center mt-4">
    <div class="card mx-auto shadow-sm" style="max-width: 400px;">
      <div class="card-body">
        <h5 class="card-title">ä»Šæœˆã®åˆè¨ˆé‡‘é¡</h5>
        <p class="card-text display-6">Â¥{{ total_amount |intcomma }}</p>
      </div>
    </div>
  </div>
</div>

<!--    ã‚ãˆãˆãˆãˆãˆãˆãˆãˆãˆãˆãˆãˆãˆãˆãˆãˆãˆãˆãˆãˆãˆãˆãˆ-->
 <h2 class="text-center mt-4">{{ current_year }}å¹´{{ current_month }}æœˆã®æ˜ç´°ä¸€è¦§</h2>


<!--ã‚«ãƒ†ã‚´ãƒªãƒ¼è¨­å®šã®ã‚³ãƒ¼ãƒ‰-->
{% if details %}
<div class="container mt-4">
  <div class="text-center mb-3">
    <button class="btn btn-primary me-2" id="edit-btn">ç·¨é›†</button>
    <button class="btn btn-success d-none" id="save-btn">ç¢ºå®š</button>
  </div>

  <div class="table-responsive">
    <table class="table table-bordered text-center align-middle" id="detail-table">
      <thead class="table-light">
        <tr>
          <th>æ—¥ä»˜</th>
          <th>ã‚«ãƒ†ã‚´ãƒªãƒ¼</th>
          <th>é‡‘é¡</th>
          <th>ã‚¿ã‚°/ã‚³ãƒ¡ãƒ³ãƒˆ</th>
        </tr>
      </thead>
      <tbody>
        {% for item in details %}
          <tr data-id="{{ item.id }}">
            <td>{{ item.date }}</td>
            <td class="category-cell">
              <span class="category-text">{{ item.category }}</span>
              <select class="form-select category-select d-none">
                {% for cat in categories %}
                  <option value="{{ cat }}" {% if cat == item.category %}selected{% endif %}>{{ cat }}</option>
                {% endfor %}
              </select>
            </td>
            <td>Â¥{{ item.amount|intcomma }}</td>
            <td class="tag-cell">
  <span class="tag-text">{{ item.tag }}</span> <!-- ğŸ‘ˆ ã‚³ã‚³ãŒå¿…è¦ -->
  <input type="text" class="form-control tag-input d-none" value="{{ item.tag }}"> <!-- ğŸ‘ˆ ã“ã“ã‚‚ -->
</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% else %}
  <p class="text-center">è©²å½“ã™ã‚‹æ˜ç´°ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
{% endif %}

<!--ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ†é¡-->
<!--<script>-->
<!--document.getElementById('edit-btn').addEventListener('click', function () {-->
<!--  document.querySelectorAll('#detail-table .category-cell').forEach(cell => {-->
<!--    const span = cell.querySelector('.category-text');-->
<!--    const select = cell.querySelector('.category-select');-->
<!--    span.classList.add('d-none');-->
<!--    select.classList.remove('d-none');-->
<!--  });-->
<!--  document.getElementById('edit-btn').classList.add('d-none');-->
<!--  document.getElementById('save-btn').classList.remove('d-none');-->
<!--});-->

<!--document.getElementById('save-btn').addEventListener('click', function () {-->
<!--  document.querySelectorAll('#detail-table .category-cell').forEach(cell => {-->
<!--    const span = cell.querySelector('.category-text');-->
<!--    const select = cell.querySelector('.category-select');-->
<!--    const selectedValue = select.value;-->
<!--    span.textContent = selectedValue;-->
<!--    span.classList.remove('d-none');-->
<!--    select.classList.add('d-none');-->
<!--  });-->
<!--  document.getElementById('save-btn').classList.add('d-none');-->
<!--  document.getElementById('edit-btn').classList.remove('d-none');-->
<!--});-->
<!--</script>-->

<!--DBæ›´æ–°ã®å‡¦ç†-->
<!--<script>-->
<!--document.getElementById('save-btn').addEventListener('click', function () {-->
<!--  const updatedData = [];-->

<!--  document.querySelectorAll('#detail-table tbody tr').forEach(row => {-->
<!--    const id = row.dataset.id;-->
<!--    const select = row.querySelector('.category-select');-->
<!--    const span = row.querySelector('.category-text');-->
<!--    const selectedValue = select.value;-->

<!--    // è¡¨ç¤ºã‚’æ›´æ–°-->
<!--    span.textContent = selectedValue;-->
<!--    span.classList.remove('d-none');-->
<!--    select.classList.add('d-none');-->

<!--    // ãƒ‡ãƒ¼ã‚¿ã‚’é…åˆ—ã«ä¿å­˜-->
<!--    updatedData.push({ id: id, category: selectedValue });-->
<!--  });-->

<!--  // ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ï¼ˆJSONï¼‰-->
<!--  fetch('{% url "update_categories" %}', {-->
<!--    method: 'POST',-->
<!--    headers: {-->
<!--      'Content-Type': 'application/json',-->
<!--      'X-CSRFToken': '{{ csrf_token }}'-->
<!--    },-->
<!--    body: JSON.stringify({ updates: updatedData })-->
<!--  })-->
<!--  .then(response => response.json())-->
<!--  .then(data => {-->
<!--    if (data.success) {-->
<!--      alert('ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’æ›´æ–°ã—ã¾ã—ãŸ');-->
<!--    } else {-->
<!--      alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');-->
<!--    }-->
<!--  })-->
<!--  .catch(error => {-->
<!--    console.error('Error:', error);-->
<!--    alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');-->
<!--  });-->

<!--  document.getElementById('save-btn').classList.add('d-none');-->
<!--  document.getElementById('edit-btn').classList.remove('d-none');-->
<!--});-->
<!--</script>-->



<!--å††ã®å‡¦ç†å†…å®¹-->
<!--    <script>const labels = {{ labels|safe }};-->
<!--    const dataValues = {{ data|safe }};-->

<!--    if (dataValues.length === 0 || dataValues.reduce((a, b) => a + b, 0) === 0) {-->
<!--        // ãƒ‡ãƒ¼ã‚¿ãŒç©ºã€ã¾ãŸã¯å…¨ã¦ã‚¼ãƒ­ â†’ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º-->
<!--        document.getElementById('myPieChart').style.display = 'none';-->
<!--        document.getElementById('no-data-message').style.display = 'block';-->
<!--    } else {-->
<!--        // é€šå¸¸ã®ã‚°ãƒ©ãƒ•æç”»-->
<!--        document.getElementById('myPieChart').style.display = 'block';-->
<!--        const ctx = document.getElementById('myPieChart').getContext('2d');-->
<!--        const myPieChart = new Chart(ctx, {-->
<!--            type: 'pie',-->
<!--            data: {-->
<!--                labels: labels,-->
<!--                datasets: [{-->
<!--                    data: dataValues,-->
<!--                    backgroundColor: [-->
<!--                        'rgba(255, 99, 132, 0.6)',-->
<!--                        'rgba(54, 162, 235, 0.6)',-->
<!--                        'rgba(255, 206, 86, 0.6)',-->
<!--                        'rgba(75, 192, 192, 0.6)',-->
<!--                        'rgba(153, 102, 255, 0.6)',-->
<!--                        'rgba(255, 159, 64, 0.6)'-->
<!--                    ]-->
<!--                }]-->
<!--            },-->
<!--            options: {-->
<!--                responsive: false-->
<!--            }-->
<!--        });-->
<!--    }-->


<!-- ã‚«ãƒ†ã‚´ãƒªãƒ¼é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="categoryModal" tabindex="-1" aria-labelledby="categoryModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered"> <!-- ä¸­å¤®è¡¨ç¤ºã®ãŸã‚ã«ã‚¯ãƒ©ã‚¹è¿½åŠ  -->
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="categoryModalLabel">ã‚«ãƒ†ã‚´ãƒªãƒ¼é¸æŠ</h5>
      </div>
      <div class="modal-body">
        <p id="modal-message"></p>
        <select id="category-select" class="form-select">
          <option value="">-- ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>
          {% for cat in categories %}
            <option value="{{ cat }}">{{ cat }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="modal-footer">
        <button type="button" id="save-category-btn" class="btn btn-primary">ä¿å­˜</button>
      </div>
    </div>
  </div>
</div>





    <div id="detail-list" style="margin-top: 30px; max-width: 600px; margin-left: auto; margin-right: auto;">
        <!-- ã“ã“ã«ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚«ãƒ†ã‚´ãƒªãƒ¼ã®æ˜ç´°ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º -->
    </div>

</div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{% static 'accountbook/js/scripts.js'%}"></script>
<!-- Bootstrap CSSï¼ˆã‚‚ã†èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ãªã‚‰ä¸è¦ï¼‰ -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Bootstrap JavaScriptï¼ˆã“ã‚ŒãŒå¿…è¦ï¼ï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  document.getElementById('edit-btn').addEventListener('click', function () {
    document.querySelectorAll('#detail-table .category-cell').forEach(cell => {
      cell.querySelector('.category-text').classList.add('d-none');
      cell.querySelector('.category-select').classList.remove('d-none');
    });

    document.querySelectorAll('#detail-table .tag-cell').forEach(cell => {
      cell.querySelector('.tag-text').classList.add('d-none');
      cell.querySelector('.tag-input').classList.remove('d-none');
    });

    document.getElementById('edit-btn').classList.add('d-none');
    document.getElementById('save-btn').classList.remove('d-none');
  });

  document.getElementById('save-btn').addEventListener('click', function () {
    const updates = [];

    document.querySelectorAll('#detail-table tbody tr').forEach(row => {
      const id = row.dataset.id;
      const category = row.querySelector('.category-select').value;
      const tag = row.querySelector('.tag-input').value;

      row.querySelector('.category-text').textContent = category;
      row.querySelector('.category-text').classList.remove('d-none');
      row.querySelector('.category-select').classList.add('d-none');

      row.querySelector('.tag-text').textContent = tag;
      row.querySelector('.tag-text').classList.remove('d-none');
      row.querySelector('.tag-input').classList.add('d-none');

      updates.push({ id, category, tag });  // ğŸ‘ˆ ã‚¿ã‚°ã‚‚é€ä¿¡
    });

    document.getElementById('save-btn').classList.add('d-none');
    document.getElementById('edit-btn').classList.remove('d-none');

    fetch("{% url 'update_categories' %}", {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: JSON.stringify({ updates: updates })
    })
    .then(response => response.json())
    .then(data => {
      if (data.status !== 'success') {
        alert('ä¿å­˜ã«æˆåŠŸã—ã¾ã—ãŸ');
      }
    })
    .catch(error => {
      alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + error);
    });
  });
});
</script>
</body>
</html>


